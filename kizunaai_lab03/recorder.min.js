var Recorder=function(){var n=new WeakMap,d=null,r=!1;function l(e,t){e=n.get(e);if(void 0!==e)return e[t]}function p(e,t,o){var r=n.get(e);void 0===r&&(r={},n.set(e,r)),r[t]=o}function e(e){var t=document.querySelector(e.el).captureStream(e.fps);p(this,"fps",e.fps),p(this,"canvasStream",t),p(this,"videoTrackSet",!1),p(this,"recording",!1),p(this,"videoEndCallback",e.callback),p(this,"isConverting",!1),1===e.outputFormat?p(this,"outputFormat","mp4"):p(this,"outputFormat","webm"),void 0===e.width||void 0===e.height?p(this,"videoSize",null):p(this,"videoSize",[e.width,e.height])}return e.prototype.start=function(){var e=l(this,"outputFormat");if(!l(this,"videoTrackSet"))return console.error("Video Track Not Set");if((null===d||!r)&&"mp4"==e)return console.error("FFmpeg is not ready/installed!!");if(l(this,"isConverting"))return console.error("Still converting...");e=l(this,"recording");e?console.warn("Recording Now!!"):(p(this,"recording",!e),l(this,"mediaRecorder").start())},e.prototype.stop=function(){var e=l(this,"recording");return l(this,"videoTrackSet")?l(this,"isConverting")?console.error("Still converting..."):void((e=l(this,"recording"))?(p(this,"recording",!e),l(this,"mediaRecorder").stop()):console.warn("Not Recording!!")):console.error("Video Track Not Set")},e.prototype.setupTrack=function(t){function o(){p(n,"videoTrackSet",!0);var e=new MediaRecorder(i,{mimeType:"video/webm;codecs=avc1"});p(n,"mediaRecorder",e);var r=[];e.ondataavailable=function(e){r.push(e.data)},e.onstop=function(){console.info("Stopping recorder now...");var e,t,o=new Blob(r,{type:"video/webm;codecs=avc1"});"webm"==c?(t=URL.createObjectURL(o),(e=document.createElement("video")).src=t,"function"==typeof s&&s(e,t)):(d.onmessage=function(e){var t=e.data;"start"==t.type?console.info("FFmpeg has received the file"):"stderr"==t.type?console.info(t.data):"error"==t.type?(p(n,"isConverting",!1),console.error(t.data)):"done"==t.type&&(console.info("Done"),e=t.data.MEMFS[0],t=new File([e.data],"video.mp4",{type:"video/mp4"}),p(n,"isConverting",!1),"function"==typeof s&&(e=URL.createObjectURL(t),(t=document.createElement("video")).src=e,s(t,e)))},(t=new FileReader).onload=function(e){var t=l(n,"fps");d.postMessage({type:"run",TOTAL_MEMORY:1073741824,arguments:("-i video.webm -preset veryfast -qscale 0 -r "+t+" video.mp4").split(" "),MEMFS:[{name:"video.webm",data:e.target.result}]}),console.log("Converting to MP4..."),p(n,"isConverting",!0)},t.readAsArrayBuffer(o))},"function"==typeof t&&t()}var n=this,i=l(this,"canvasStream"),s=l(this,"videoEndCallback"),e=l(this,"videoSize"),c=l(this,"outputFormat"),r=i.getVideoTracks()[0],a={};null!==e&&(a={width:e[0],height:e[1]}),r.applyConstraints(a).then(function(){o()}).catch(function(e){console.error("Cannot set specific video size"),console.error(e),o()})},e.prototype.renderButton=function(e){if(!l(this,"videoTrackSet"))return console.error("Video Track Not Set");var t=this,o=l(this,"storedBtn");null!=o&&(p(this,"storedBtn",null),o.remove(),o=null);var r={recordBtnOuter:["position: absolute;","bottom: "+e.bottom+"%;","right: "+e.right+"%;","height: "+e.size+"px;","width: "+e.size+"px;","background-color: white;","border-style: solid;","border-radius: 50%;","border-color: red;","display: flex;","align-items: center;","justify-content: center;","cursor: pointer;"].join(""),recordBtn:["height: "+.8*e.size+"px;","width: "+.8*e.size+"px;","border-radius: 50%;","background-color: red;","display: flex;","align-items: center;","justify-content: center;","color: white;"].join(""),stopBtn:["height: "+.7*e.size+"px;","width: "+.7*e.size+"px;","display: flex;","align-items: center;","justify-content: center;","background-color: red;","color: white;"].join("")},e=document.createElement("div"),n=document.createElement("div");l(this,"recording");return e.style.cssText=r.recordBtnOuter,p(this,"storedBtn",e),n.style.cssText=r.recordBtn,n.innerText="REC",e.appendChild(n),e.onclick=function(){l(t,"recording")?(n.style.cssText="",n.style.cssText=r.recordBtn,n.innerText="REC",t.stop()):(n.style.cssText="",n.style.cssText=r.stopBtn,n.innerText="STOP",t.start())},e},e.prototype.getRecording=function(){return l(this,"recording")},e.prototype.installFFMPEG=function(e,t){if(void 0===e)return console.error("Must provide ffmpeg.js path!");if(null!==d)return console.error("Already installed ffmpeg!!");if(void 0===window.Worker)return console.error("Your Browser not support Web Worker!");var o=new XMLHttpRequest;o.open("GET",e),o.send(),o.onload=function(){var e=new Blob([o.responseText],{type:"text/javascript"});(d=new Worker(URL.createObjectURL(e))).onmessage=function(e){"ready"==e.data.type&&(console.info("FFmpeg is installed!"),r=!0)},d.postMessage({type:"ready"}),"function"==typeof t&&t()},o.onerror=function(){console.error("Loading ffmpeg web worker failed, maybe the specific path is wrong")}},e}();